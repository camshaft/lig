#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander');
var spawn = require('win-fork');
var axon = require('axon');
var pull = axon.socket('pull');
var pub = axon.socket('pub');
var CBuffer = require('CBuffer');
var parseAddress = require('../lib/util').parseAddress;

/**
 * usage
 */

program
  .version(require('../package').version)
  .option('-s, --size <size>', 'size of the buffer', '5000')
  .option('-a, --address <address>', 'address of log server', 'tcp://0.0.0.0:91988')
  .option('-p, --pubsub <address>', 'address of pubsub server', 'tcp://0.0.0.0:10588');

/**
 * parse argv
 */

program.parse(process.argv);

var buf = new CBuffer(parseInt(program.size, 10));

/**
 * define our axon codec
 */

axon.codec.define('json', {
  encode: JSON.stringify,
  decode: JSON.parse
});
pull.format('json');
pub.format('json');

/**
 * start up our servers
 */

pull.bind(parseAddress(program.address));
pub.bind(parseAddress(program.pubsub));

pull.on('message', function(msg) {
  buf.push(msg);
  pub.send(msg);
});

pub.on('connect', function(client) {
  buf.forEach(function(m) {
    client.send(m);
  });
});
